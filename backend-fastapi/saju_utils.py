
"""
사주 명리학 계산을 위한 유틸리티 모듈
- 오행, 십성, 12운성, 대운, 세운, 신살, 형충회합 매핑 및 계산 로직 포함
"""
import pandas as pd
from datetime import datetime

# 천간 및 지지
HEAVENLY_STEMS = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸']
EARTHLY_BRANCHES = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥']

# 60갑자 리스트
GANZHI_LIST = [
    '甲子', '乙丑', '丙寅', '丁卯', '戊辰', '己巳', '庚午', '辛未', '壬申', '癸酉',
    '甲戌', '乙亥', '丙子', '丁丑', '戊寅', '己卯', '庚辰', '辛巳', '壬午', '癸未',
    '甲申', '乙酉', '丙戌', '丁亥', '戊子', '己丑', '庚寅', '辛卯', '壬辰', '癸巳',
    '甲午', '乙미', '丙申', '丁酉', '戊戌', '己亥', '庚자', '辛丑', '壬寅', '癸卯',
    '甲辰', '乙巳', '丙午', '丁未', '戊申', '己酉', '庚戌', '辛亥', '壬자', '癸丑',
    '甲寅', '乙卯', '丙辰', '丁巳', '戊午', '己未', '庚申', '辛酉', '壬戌', '癸亥'
]
# 오타 최종 정화
GANZHI_LIST[31] = '乙未'
GANZHI_LIST[36] = '庚子'
GANZHI_LIST[48] = '壬子'

# 오행 매핑
ELEMENTS_MAP = {
    '甲': '목', '乙': '목', '丙': '화', '丁': '화', '戊': '토', '己': '토', '庚': '금', '辛': '금', '壬': '수', '癸': '수',
    '寅': '목', '卯': '목', '巳': '화', '午': '화', '辰': '토', '戌': '토', '丑': '토', '未': '토', '申': '금', '酉': '금', '亥': '수', '子': '수'
}

# 십성 매핑
GAN_TEN_GODS = {
    '甲': {'甲':'비견','乙':'겁재','丙':'식신','丁':'상관','戊':'편재','己':'정재','庚':'편관','辛':'정관','壬':'편인','癸':'정인'},
    '乙': {'甲':'겁재','乙':'비견','丙':'상관','丁':'식신','戊':'정재','己':'편재','庚':'정관','辛':'편관','壬':'정인','癸':'편인'},
    '丙': {'甲':'편인','乙':'정인','丙':'비견','丁':'겁재','戊':'식신','己':'상관','庚':'편재','辛':'정재','壬':'편관','癸':'정관'},
    '丁': {'甲':'정인','乙':'편인','丙':'겁재','丁':'비견','戊':'상관','己':'식신','庚':'정재','辛':'편재','壬':'정관','癸':'편관'},
    '戊': {'甲':'편관','乙':'정관','丙':'편인','丁':'정인','戊':'비견','己':'겁재','庚':'식신','辛':'상관','壬':'편재','癸':'정재'},
    '己': {'甲':'정관','乙':'편관','丙':'정인','丁':'편인','戊':'겁재','己':'비견','庚':'상관','辛':'식신','壬':'정재','癸':'편재'},
    '庚': {'甲':'편재','乙':'정재','丙':'편관','丁':'정관','戊':'편인','己':'정인','庚':'비견','辛':'겁재','壬':'식신','癸':'상관'},
    '辛': {'甲':'정재','乙':'편재','丙':'정관','丁':'편관','戊':'정인','己':'편인','庚':'겁재','辛':'비견','壬':'상관','癸':'식신'},
    '壬': {'甲':'식신','乙':'상관','丙':'편재','丁':'정재','戊':'편관','己':'정관','庚':'편인','辛':'정인','壬':'비견','癸':'겁재'},
    '癸': {'甲':'상관','乙':'식신','丙':'정재','丁':'편재','戊':'정관','己':'편관','庚':'정인','辛':'편인','壬':'겁재','癸':'비견'}
}

# 지장간 정기
BRANCH_HIDDEN_GANS = {
    '子': '癸', '丑': '己', '寅': '甲', '卯': '乙',
    '辰': '戊', '巳': '丙', '午': '丁', '未': '己',
    '申': '庚', '酉': '辛', '戌': '戊', '亥': '壬'
}

# 12운성
TWELVE_GROWTH = {
    '甲': { '亥': '장생', '子': '목욕', '丑': '관대', '寅': '건록', '卯': '제왕', '辰': '쇠', '巳': '병', '午': '사', '未': '묘', '申': '절', '酉': '태', '戌': '양' },
    '乙': { '午': '장생', '巳': '목욕', '辰': '관대', '卯': '건록', '寅': '제왕', '丑': '쇠', '子': '병', '亥': '사', '戌': '묘', '酉': '절', '申': '태', '未': '양' },
    '丙': { '寅': '장생', '卯': '목욕', '辰': '관대', '巳': '건록', '午': '제왕', '未': '쇠', '申': '병', '酉': '사', '戌': '묘', '亥': '절', '子': '태', '丑': '양' },
    '丁': { '酉': '장생', '申': '목욕', '未': '관대', '午': '건록', '巳': '제왕', '辰': '쇠', '卯': '병', '寅': '사', '丑': '묘', '子': '절', '亥': '태', '戌': '양' },
    '戊': { '寅': '장생', '卯': '목욕', '辰': '관대', '巳': '건록', '午': '제왕', '未': '쇠', '申': '병', '酉': '사', '戌': '묘', '亥': '절', '子': '태', '丑': '양' },
    '己': { '酉': '장생', '申': '목욕', '未': '관대', '午': '건록', '巳': '제왕', '辰': '쇠', '卯': '병', '寅': '사', '丑': '묘', '子': '절', '亥': '태', '戌': '양' },
    '庚': { '巳': '장생', '午': '목욕', '未': '관대', '申': '건록', '酉': '제왕', '戌': '쇠', '亥': '병', '子': '사', '丑': '묘', '寅': '절', '卯': '태', '辰': '양' },
    '辛': { '子': '장생', '亥': '목욕', '戌': '관대', '酉': '건록', '申': '제왕', '未': '쇠', '午': '병', '巳': '사', '辰': '묘', '卯': '절', '寅': '태', '丑': '양' },
    '壬': { '申': '장생', '酉': '목욕', '戌': '관대', '亥': '건록', '子': '제왕', '丑': '쇠', '寅': '병', '卯': '사', '辰': '묘', '巳': '절', '午': '태', '未': '양' },
    '癸': { '卯': '장생', '寅': '목욕', '丑': '관대', '子': '건록', '亥': '제왕', '戌': '쇠', '酉': '병', '申': '사', '未': '묘', '午': '절', '巳': '태', '辰': '양' }
}

# 천간 합/충 매핑
STEM_RELATIONS = {
    '합': {'甲':'己', '己':'甲', '乙':'庚', '庚':'乙', '丙':'辛', '辛':'丙', '丁':'壬', '壬':'丁', '戊':'癸', '癸':'戊'},
    '충': {'甲':'庚', '庚':'甲', '乙':'辛', '辛':'乙', '丙':'壬', '壬':'丙', '丁':'癸', '癸':'丁'}
}

# 지지 형충회합 매핑
BRANCH_RELATIONS = {
    '합': {'子':'丑', '丑':'子', '寅':'亥', '亥':'寅', '卯':'戌', '戌':'卯', '辰':'酉', '酉':'辰', '巳':'申', '申':'巳', '午':'未', '未':'午'},
    '충': {'子':'午', '午':'子', '丑':'未', '未':'丑', '寅':'申', '申':'寅', '卯':'酉', '酉':'卯', '辰':'戌', '戌':'辰', '巳':'亥', '亥':'巳'},
    '형': {
        '寅':['巳','申'], '巳':['申','寅'], '申':['寅','巳'], 
        '丑':['戌','未'], '戌':['未','丑'], '未':['丑','戌'], 
        '子':'卯', '卯':'子', 
        '辰':'辰', '午':'午', '酉':'酉', '亥':'亥'
    },
    '파': {'子':'酉', '酉':'子', '丑':'辰', '辰':'丑', '寅':'亥', '亥':'寅', '卯':'午', '午':'卯', '巳':'申', '申':'巳', '未':'戌', '戌':'未'},
    '해': {'子':'未', '未':'子', '丑':'午', '午':'丑', '寅':'巳', '巳':'寅', '卯':'辰', '辰':'卯', '申':'亥', '亥':'申', '酉':'戌', '戌':'酉'},
    '원진': {'子':'未', '未':'子', '丑':'午', '午':'丑', '寅':'酉', '酉':'寅', '卯':'申', '申':'卯', '辰':'亥', '亥':'辰', '巳':'戌', '戌':'巳'},
    '귀문': {'子':'未', '未':'子', '丑':'午', '午':'丑', '寅':'未', '未':'寅', '卯':'申', '申':'卯', '辰':'亥', '亥':'辰', '巳':'戌', '戌':'巳'}
}

def get_ganzhi_index(ganzhi):
    try: return GANZHI_LIST.index(ganzhi)
    except: return -1

def get_next_ganzhi(ganzhi, step=1):
    idx = get_ganzhi_index(ganzhi)
    if idx == -1: return ""
    return GANZHI_LIST[(idx + step) % 60]

def get_prev_ganzhi(ganzhi, step=1):
    idx = get_ganzhi_index(ganzhi)
    if idx == -1: return ""
    return GANZHI_LIST[(idx - step) % 60]

def calculate_daeun_number(year, month, day, hour, minute, is_forward):
    """대운수 계산 (12절기 Jeol 기준 정밀화)"""
    try:
        from sajupy import get_saju_calculator
        calc = get_saju_calculator()
        df = calc.data
        birth_dt = datetime(year, month, day, hour, minute)
        
        # 12절기만 필터링 (명리학 대운수는 절기 기준임)
        jeols = ['입춘', '경칩', '청명', '입하', '망종', '소서', '입추', '백로', '한로', '입동', '대설', '소한']
        df_jeol = df[df['solar_term_korean'].isin(jeols)].copy()
        
        df_jeol['term_dt'] = pd.to_datetime(df_jeol['term_time'].astype(str).str.split('.').str[0], format='%Y%m%d%H%M')

SAJU_TERMS = {
    # 십성 (Ten Gods)
    "본인": "사주의 주인인 '일간' 자신을 의미합니다.",
    "비견": "나와 오행과 음양이 같은 성분으로, 주관, 독립심, 평등한 인간관계를 의미합니다.",
    "겁재": "나와 오행은 같으나 음양이 다른 성분으로, 경쟁심, 투쟁심, 재물을 나누는 성질을 의미합니다.",
    "식신": "내가 생하는 성분으로 음양이 같은 것. 의식주, 창의성, 연구심, 부드러운 표현력을 의미합니다.",
    "상관": "내가 생하는 성분으로 음양이 다른 것. 재능 표출, 비판력, 화려한 언변, 예술성을 의미합니다.",
    "편재": "내가 극하는 성분으로 음양이 같은 것. 유동적인 재물, 공간 지각력, 사업적 수완을 의미합니다.",
    "정재": "내가 극하는 성분으로 음양이 다른 것. 고정적인 재물, 성실성, 치밀한 관리 능력을 의미합니다.",
    "편관": "나를 극하는 성분으로 음양이 같은 것. 권위, 규율, 명예심, 때로는 강한 압박감을 의미합니다.",
    "정관": "나를 극하는 성분으로 음양이 다른 것. 합리적인 규칙, 안정된 직장, 도덕성, 보수적 성향을 의미합니다.",
    "편인": "나를 생하는 성분으로 음양이 같은 것. 독창적인 학문, 직관력, 신비주의, 고독한 사유를 의미합니다.",
    "정인": "나를 생하는 성분으로 음양이 다른 것. 전통적인 학문, 자애로움, 수용성, 문서운을 의미합니다.",

    # 12운성 (Twelve Growth)
    "장생": "갓 태어난 상태로, 강한 생명력과 주변의 도움을 받는 귀한 기운입니다.",
    "목욕": "태어나 씻는 과정으로, 호기심, 노출, 화려함, 때로는 시행착오를 의미합니다.",
    "관대": "옷을 갖추어 입는 청년기로, 패기, 추진력, 강한 자아를 의미합니다.",
    "건록": "벼슬에 나아가는 전성기로, 안정된 기반, 독립심, 사회적 성공을 의미합니다.",
    "제왕": "기운이 절정에 달한 상태로, 정점에서의 권위와 카리스마를 의미합니다.",
    "쇠": "정점에서 한풀 꺾인 상태이나, 노련미와 원숙함, 지혜를 갖춘 기운입니다.",
    "병": "기운이 약해져 쉬어가는 단계로, 역지사지의 마음과 감수성이 풍부해집니다.",
    "사": "정적인 상태로, 집중력, 사유, 예술적 깊이를 의미합니다.",
    "묘": "창고에 저장된 상태로, 근검절약, 실속, 조용히 내실을 다지는 기운입니다.",
    "절": "기운이 완전히 끊어진 상태이나, 무(無)에서 유(有)를 창조하는 반전의 가능성을 가집니다.",
    "태": "잉태된 상태로, 무궁무진한 꿈과 미래에 대한 희망을 의미합니다.",
    "양": "길러지는 과정으로, 보호받고 양육되며 준비하는 안락한 기운입니다.",

    # 주요 신살 (Sinsal) - 일부 예시
    "천을귀인": "사주에서 가장 존귀한 길신으로, 흉을 길로 바꾸고 인덕을 입게 합니다.",
    "화개살": "예술, 종교, 철학적 재능이 뛰어나며 화려함을 덮고 내면으로 침잠하는 성질입니다.",
    "역마살": "활동적이고 이동이 잦으며, 변화를 통해 발전하는 역동적인 기운입니다.",
    "도화살": "시선을 끄는 매력과 인기, 감수성과 예술적 재질을 의미합니다.",
    "백호대살": "강한 에너지와 카리스마를 지니며, 큰 일을 성취하거나 급격한 변화를 겪는 기운입니다.",
    "괴강살": "우두머리 기질과 강한 자존심, 극단적인 성패를 병행하는 기운입니다.",
    "문창귀인": "학문과 예술에 소질이 있고 총명하며 창의력이 뛰어난 길신입니다.",
    "망신살": "자신의 모습이 노출되어 유명세를 타거나, 실수로 인해 구설에 오르는 기운입니다.",
    "장성살": "권위와 지위를 얻고 중심 세력이 되는 당당한 기운입니다.",
    "지살": "땅과의 인연으로 이동하거나 변화를 겪으며 기반을 다지는 기운입니다.",
    "천살": "하늘의 뜻에 의한 불가항력적인 변화나 하늘을 공경하는 마음을 의미합니다.",
    "년살": "인기를 얻고 시선을 끌며 재능을 꽃피우는 시기입니다.",
    "월살": "어둠 속의 달빛처럼 고난 속에서 지혜를 얻고 타인을 돕는 기운입니다.",
    "반안살": "말 안장에 오르는 격으로, 편안한 직위와 사회적 예우를 받는 기운입니다.",
    "육해살": "여섯 가지 해로움이 있으나, 거동의 변화와 영적 직관력이 발달하는 기운입니다.",
    "재살": "재난을 피하거나 꾀를 써서 위기를 극복하는 지략의 기운입니다.",
    "공망": "비어 있음(空)과 잃음(亡)을 의미하며, 해당 자리에 대한 집착이나 세속적 성취가 약함을 뜻합니다.",

    # 천간 (Heavenly Stems)
    "갑": "직선적이고 위로 솟구치는 기운으로, 새로움, 시작, 개척자 정신을 의미합니다.",
    "을": "유연하고 생명력이 끈질긴 기운으로, 적응력, 생존력, 섬세한 창의성을 의미합니다.",
    "병": "화려하게 빛나는 태양과 같은 기운으로, 열정, 확산, 예의, 명확함을 의미합니다.",
    "정": "따뜻하고 은은한 촛불과 같은 기운으로, 헌신, 예술성, 내면의 강한 집중력을 의미합니다.",
    "무": "넓고 깊은 대지나 높은 산과 같은 기운으로, 포용력, 신용, 중재자적 성향을 의미합니다.",
    "기": "비옥한 밭이나 정원과 같은 기운으로, 생산성, 세심함, 안정감, 어머니의 마음을 의미합니다.",
    "경": "단단한 바위나 원석과 같은 기운으로, 의리, 단호함, 개혁, 결단력을 의미합니다.",
    "신": "정교한 보석이나 칼날과 같은 기운으로, 깔끔함, 완성도, 날카로운 직관력을 의미합니다.",
    "임": "깊고 넓은 호수나 강물과 같은 기운으로, 지혜, 유연성, 수용성, 깊은 사유를 의미합니다.",
    "계": "촉촉하게 내리는 단비와 같은 기운으로, 영리함, 섬세한 감수성, 생명력을 깨우는 힘을 의미합니다.",

    # 한자 키 추가 (천간)
    "甲": "직선적이고 위로 솟구치는 기운으로, 새로움, 시작, 개척자 정신을 의미합니다.",
    "乙": "유연하고 생명력이 끈질긴 기운으로, 적응력, 생존력, 섬세한 창의성을 의미합니다.",
    "丙": "화려하게 빛나는 태양과 같은 기운으로, 열정, 확산, 예의, 명확함을 의미합니다.",
    "丁": "따뜻하고 은은한 촛불과 같은 기운으로, 헌신, 예술성, 내면의 강한 집중력을 의미합니다.",
    "戊": "넓고 깊은 대지나 높은 산과 같은 기운으로, 포용력, 신용, 중재자적 성향을 의미합니다.",
    "己": "비옥한 밭이나 정원과 같은 기운으로, 생산성, 세심함, 안정감, 어머니의 마음을 의미합니다.",
    "庚": "단단한 바위나 원석과 같은 기운으로, 의리, 단호함, 개혁, 결단력을 의미합니다.",
    "辛": "정교한 보석이나 칼날과 같은 기운으로, 깔끔함, 완성도, 날카로운 직관력을 의미합니다.",
    "壬": "깊고 넓은 호수나 강물과 같은 기운으로, 지혜, 유연성, 수용성, 깊은 사유를 의미합니다.",
    "癸": "촉촉하게 내리는 단비와 같은 기운으로, 영리함, 섬세한 감수성, 생명력을 깨우는 힘을 의미합니다.",

    # 지지 (Earthly Branches)
    "자": "지혜와 생명의 씨앗을 품은 기운으로, 신중함, 사교성, 새로운 시작을 의미합니다.",
    "축": "끈기 있게 때를 기다리는 기운으로, 성실성, 실속, 고집, 내면의 에너지를 의미합니다.",
    "인": "역동적으로 튀어 오르는 범의 기운으로, 열정, 리더십, 독립심, 추진력을 의미합니다.",
    "묘": "유연하고 민감한 토끼의 기운으로, 창의성, 적응력, 섬세함, 정적인 아름다움을 의미합니다.",
    "진": "변화무쌍하고 거대한 용의 기운으로, 이상주의, 명예욕, 활동성, 잠재력을 의미합니다.",
    "사": "빠르게 움직이고 화려한 뱀의 기운으로, 열정, 예술적 감각, 집중력, 변혁을 의미합니다.",
    "오": "정오의 태양처럼 활기찬 말의 기운으로, 개방성, 솔직함, 정열, 화려함을 의미합니다.",
    "미": "안정적이고 온화한 양의 기운으로, 인내심, 희생정신, 고집, 마무리의 힘을 의미합니다.",
    "신": "재주 많고 영리한 원숭이의 기운으로, 다재다능, 임기응변, 기술력, 변화를 의미합니다.",
    "유": "결실을 맺고 성숙한 닭의 기운으로, 깔끔함, 정확함, 고집, 미적 감각을 의미합니다.",
    "술": "신의를 지키고 우직한 개의 기운으로, 책임감, 충성심, 철학적 성향을 의미합니다.",
    "해": "모든 것을 수렴하고 지혜로운 돼지의 기운으로, 포용력, 식복, 여유, 깊은 통찰을 의미합니다.",

    # 한자 키 추가 (지지)
    "子": "지혜와 생명의 씨앗을 품은 기운으로, 신중함, 사교성, 새로운 시작을 의미합니다.",
    "丑": "끈기 있게 때를 기다리는 기운으로, 성실성, 실속, 고집, 내면의 에너지를 의미합니다.",
    "寅": "역동적으로 튀어 오르는 범의 기운으로, 열정, 리더십, 독립심, 추진력을 의미합니다.",
    "卯": "유연하고 민감한 토끼의 기운으로, 창의성, 적응력, 섬세함, 정적인 아름다움을 의미합니다.",
    "辰": "변화무쌍하고 거대한 용의 기운으로, 이상주의, 명예욕, 활동성, 잠재력을 의미합니다.",
    "巳": "빠르게 움직이고 화려한 뱀의 기운으로, 열정, 예술적 감각, 집중력, 변혁을 의미합니다.",
    "午": "정오의 태양처럼 활기찬 말의 기운으로, 개방성, 솔직함, 정열, 화려함을 의미합니다.",
    "未": "안정적이고 온화한 양의 기운으로, 인내심, 희생정신, 고집, 마무리의 힘을 의미합니다.",
    "申": "재주 많고 영리한 원숭이의 기운으로, 다재다능, 임기응변, 기술력, 변화를 의미합니다.",
    "酉": "결실을 맺고 성숙한 닭의 기운으로, 깔끔함, 정확함, 고집, 미적 감각을 의미합니다.",
    "戌": "신의를 지키고 우직한 개의 기운으로, 책임감, 충성심, 철학적 성향을 의미합니다.",
    "亥": "모든 것을 수렴하고 지혜로운 돼지의 기운으로, 포용력, 식복, 여유, 깊은 통찰을 의미합니다.",

    # 12신살 (Twelve Sinsal) - 전수 보강
    "겁살": "빼앗긴다는 의미보다 외부의 강한 압력에 대응하며 경쟁력을 키우는 기운입니다. 강한 추진력과 경쟁심을 유발합니다.",
    "재살": "꾀를 써서 위기를 극복하는 지략의 기운입니다. 수옥살이라고도 하며, 갇힌 환경에서 지혜를 발휘해 탈출하는 능력을 뜻합니다.",
    "천살": "하늘의 뜻에 의한 불가항력적인 변화를 의미합니다. 스스로 조절하기 힘든 환경이나 하늘을 공경하는 마음을 뜻하며, 정신적 성숙을 돕습니다.",
    "지살": "땅과의 인연으로 이동하거나 새로운 터전을 마련하는 기운입니다. 자발적인 이동과 시작, 홍보 및 대외적인 활동에 유리합니다.",
    "년살": "도화살이라고도 하며, 시선을 끌고 인기를 얻는 기운입니다. 예술적 감각과 매력을 발산하여 대중의 사랑을 받는 힘입니다.",
    "월살": "어둠 속의 달빛처럼 고난 속에서 지혜를 얻고 타인을 돕는 기운입니다. 상속, 위상 제고, 또는 반전의 행운을 암시하기도 합니다.",
    "망신살": "풍부한 표현력으로 자신을 드러내어 주목받는 기운입니다. 전문 분야에서 이름을 날리거나 대중 앞에 나서는 활동에 적합합니다.",
    "장성살": "권위와 지위를 얻고 조직의 중심 세력이 되는 당당함입니다. 리더십이 발달하고 주도적으로 일을 처리하는 능력을 의미합니다.",
    "반안살": "말 안장에 오르는 격으로, 안락한 지위와 사회적 예우를 받는 서기(瑞氣)입니다. 승진, 합격, 경제적 안정을 뜻합니다.",
    "역마살": "활동 영역이 넓고 이동이 잦은 역동적인 기운입니다. 해외 운이나 유통, 통신 등 변화가 많은 분야에서 크게 발복합니다.",
    "육해살": "빠른 동작과 예리한 직관력을 의미합니다. 조상의 음덕을 입거나 영적인 감각이 발달하여 위기 상황을 기민하게 헤쳐 나가는 힘입니다.",
    "화개살": "예술, 종교, 인문학적 깊이가 깊은 성분입니다. 화려함을 덮고 내실을 기하며, 과거의 것을 복구하거나 정신적인 가치를 창조합니다.",

    # 상호 관계 상세화 및 접두사 버전 명시 (사용자 요청 반영)
    "합": "서로 다른 기운이 만나 조화를 이루고 새로운 에너지를 만드는 긍정적 결합입니다. 화합, 협력, 생산성을 뜻하며 갈등이 해소되는 시기입니다.",
    "충": "정면으로 부딪혀 낡은 것을 깨고 새로운 변화를 이끌어내는 역동적인 변화입니다. 이동, 이직, 가치관의 전환 등 큰 혁신이 일어납니다.",
    "형": "기운이 깎이고 다듬어지는 과정입니다. 정교한 설계나 조정, 법률, 의료 등 전문적인 재능을 뜻하며 실수를 줄이고 완성도를 높이는 운입니다.",
    "파": "일시적으로 흩어지거나 수정이 필요한 상태입니다. 결과물을 보완하고 다듬는 섬세함이 요구되며, 내실을 다져 더 큰 성장을 준비하는 단계입니다.",
    "해": "서로의 기운을 간섭하거나 방해하는 현상입니다. 대인관계에서의 오해를 주의하고 상대를 존중하며 침착하게 대응하면 오히려 성숙해지는 계기가 됩니다.",
    "원진": "까닭 없이 서로를 원망하게 되는 감정적인 기운입니다. 감정 소모를 피하고 각자의 개성을 존중하며 거리를 두는 지혜가 필요한 시기입니다.",
    "귀문": "영감이 극도로 발달하고 직관력이 날카로워지는 기운입니다. 예술적 영감이나 학문적 탐구력으로 승화시키면 천재성을 발휘하게 됩니다.",
    
    # 일/월/년/시 접두사 명시적 추가 (확실한 매핑 보장)
    "일충": "나의 중심인 일지와 충돌하는 기운으로, 생활 환경이나 배우자궁에 새로운 변화와 혁신의 바람이 부는 시기입니다.",
    "일합": "나의 중심인 일지와 결합하는 기운으로, 소중한 인연을 만나거나 가정에 안정이 찾아오고 협력자가 나타나는 운입니다.",
    "일형": "일지가 형을 받는 기운으로, 자신의 전문성을 갈고닦거나 생활 방식을 정교하게 조정하여 내적 성숙을 이루는 시기입니다.",
    "일파": "일지가 파를 받는 기운으로, 현재 진행 중인 일이나 인간관계에서 미세한 부분을 조정하고 보완하여 완성도를 높여야 하는 운입니다.",
    "일해": "일지와 해의 관계를 맺는 기운으로, 주변과의 미묘한 갈등을 지혜롭게 대처하고 내면의 중심을 지키는 노력이 필요합니다.",
    "일원진": "감정이 예민해지기 쉬운 운입니다. 가까운 사람과의 관계에서 서로의 다름을 인정하고 여유로운 마음을 가지면 평온해집니다.",
    "일귀문": "직관력과 감수성이 매우 높아지는 시기입니다. 이를 창작 활동이나 깊은 사유로 연결하면 예리한 통찰을 얻을 수 있습니다.",
    
    "월충": "사회적 환경인 월지와 충돌하여 직장운이나 사회적 관계에 큰 변화가 생기고, 새로운 환경으로 도약하는 계기가 됩니다.",
    "월합": "사회적 기반인 월지와 화합하여 조직 내에서 인정을 받거나 비즈니스 파트너십이 강화되는 긍정적인 운입니다.",
    "월원진": "사회생활 중 오해가 생길 수 있으니 감정 조절에 유의하고 공적인 일에 집중하여 차분하게 대처하는 것이 유리합니다.",
    "월귀문": "업무상 창의적인 아이디어가 샘솟는 시기입니다. 예리한 분석력으로 복잡한 문제를 해결할 수 있는 힘이 생깁니다.",
    
    "년충": "조상이나 국가적 환경인 년지와 충돌하여 거주지의 대대적인 이동이나 집안의 환경 변화 등을 겪으며 새로운 기틀을 마련합니다.",
    "년합": "근본적인 기반인 년지와 결합하여 집안의 경사가 생기거나 국가적/사회적 명예를 얻는 등 경사스러운 일이 따르는 운입니다.",
    
    "시충": "미래의 자리인 시지와 충돌하여 자녀 문제나 노후 준비, 혹은 개인적인 비밀 프로젝트에 변화와 개혁이 필요한 시기입니다.",
    "시합": "결실의 자리인 시지와 화합하여 자신이 남긴 성과물이 빛을 발하거나 자손에게 기쁜 소식이 전해지는 운입니다.",

    # 기타 자주 나오는 단어 및 보강
    "본인": "사주의 주인인 '일간' 자신을 의미하며, 나의 삶의 중심이 되는 기운입니다.",
    "공망(空亡)": "비어 있음과 잃음을 의미합니다. 세속적인 욕심을 내려놓고 정신적, 철학적 가치를 추구하면 더욱 큰 깨달음과 성취를 얻는 기운입니다.",
    "귀인": "어려운 시기에 나를 돕는 조력자가 나타나거나, 예기치 못한 행운이 따르는 상서로운 기운입니다.",
    "용신": "사주의 균형을 잡아주는 핵심 기운으로, 나의 삶을 가장 유리하게 이끌어주는 '희망의 열쇠'와 같습니다.",
    "격국": "타고난 사주의 그릇과 성격, 사회적 직업적 틀을 의미합니다. 인생의 전체적인 밑그림이라 할 수 있습니다.",
    "희신": "용신을 돕는 기운으로, 삶을 부드럽고 원활하게 만드는 든든한 조력 기운입니다.",
    "기신": "나의 기운을 다소 거스르거나 균형을 깨뜨리는 성분이지만, 이를 극복하면 더 큰 그릇으로 성장하는 기회가 됩니다."
}
        
        df_jeol['term_dt'] = pd.to_datetime(df_jeol['term_time'].astype(str).str.split('.').str[0], format='%Y%m%d%H%M')
        
        if is_forward:
            future_terms = df_jeol[df_jeol['term_dt'] >= birth_dt]
            if future_terms.empty: return 1
            target_term = future_terms.iloc[0]['term_dt']
        else:
            past_terms = df_jeol[df_jeol['term_dt'] <= birth_dt]
            if past_terms.empty: return 1
            target_term = past_terms.iloc[-1]['term_dt']
            
        diff_seconds = abs((target_term - birth_dt).total_seconds())
        # 대운수 = 생일과 절기 사이의 일수 / 3
        daeun_num = int((diff_seconds / (24 * 3600) / 3) + 0.5)
        return max(1, daeun_num)
    except: return 1

def get_sinsal_list(ref_branch, branch):
    """지지 기반 12신살 산출 (참조 지지 기준)"""
    groups_start = {
        '寅':'寅', '午':'寅', '戌':'寅',     # 화국 -> 인지살
        '申':'申', '子':'申', '辰':'申',     # 수국 -> 신지살
        '巳':'巳', '酉':'巳', '丑':'巳',     # 금국 -> 사지살
        '亥':'亥', '卯':'亥', '未':'亥'      # 목국 -> 해지살
    }
    start_branch = groups_start.get(ref_branch, '寅')
    order = ['지살', '년살', '월살', '망신살', '장성살', '반안살', '역마살', '육해살', '화개살', '겁살', '재살', '천살']
    diff = (EARTHLY_BRANCHES.index(branch) - EARTHLY_BRANCHES.index(start_branch) + 12) % 12
    return order[diff]

def get_gongmang(ganzhi):
    """공망(Void) 산출"""
    idx = get_ganzhi_index(ganzhi)
    if idx == -1: return "-"
    # 60갑자를 10개씩 묶어 6개 조로 나눔
    group_idx = idx // 10
    gongmang_list = ['戌亥', '申酉', '午未', '辰巳', '寅卯', '子丑']
    return gongmang_list[group_idx]

def get_ganzhi_details(day_gan, year_branch, ganzhi, pillars=None, day_branch=None):
    """특정 간지의 상세 명리 데이터 산출 (다중 신살 포함)"""
    if not ganzhi or len(ganzhi) < 2: return {}
    stem, branch = ganzhi[0], ganzhi[1]
    
    # 십성 및 십이운성
    s_ten = GAN_TEN_GODS.get(day_gan, {}).get(stem, '-')
    b_ten = GAN_TEN_GODS.get(day_gan, {}).get(BRANCH_HIDDEN_GANS.get(branch), '-')
    growth = TWELVE_GROWTH.get(day_gan, {}).get(branch, '-')
    
    # 다중 신살 (년지 기준 + 가능하면 일지 기준)
    sinsal_year = get_sinsal_list(year_branch, branch)
    sinsal_combined = [sinsal_year]
    if day_branch:
        sinsal_day = get_sinsal_list(day_branch, branch)
        if sinsal_day not in sinsal_combined:
            sinsal_combined.append(sinsal_day)
    
    # 원국과의 관계
    rels = []
    if pillars:
        p_map = {'year':'년', 'month':'월', 'day':'일', 'hour':'시'}
        for k, p in pillars.items():
            name = p_map.get(k, k)
            p_stem = p.get('stem')
            p_branch = p.get('branch')
            
            # 천간 관계
            if STEM_RELATIONS['충'].get(stem) == p_stem: rels.append(f"{name}충")
            if STEM_RELATIONS['합'].get(stem) == p_stem: rels.append(f"{name}합")
            
            # 지지 관계
            if BRANCH_RELATIONS['충'].get(branch) == p_branch: rels.append(f"{name}충")
            if BRANCH_RELATIONS['합'].get(branch) == p_branch: rels.append(f"{name}합")
            
            # 지지 형(刑)
            h_val = BRANCH_RELATIONS['형'].get(branch)
            if h_val:
                if isinstance(h_val, list):
                    if p_branch in h_val: rels.append(f"{name}형")
                elif h_val == p_branch: rels.append(f"{name}형")
                
            # 지지 파(破)
            if BRANCH_RELATIONS['파'].get(branch) == p_branch: rels.append(f"{name}파")
            
            # 지지 해(害)
            if BRANCH_RELATIONS['해'].get(branch) == p_branch: rels.append(f"{name}해")
            
            # 지지 원진(元嗔)
            if BRANCH_RELATIONS['원진'].get(branch) == p_branch: rels.append(f"{name}원진")
            
            # 지지 귀문(鬼門)
            if BRANCH_RELATIONS['귀문'].get(branch) == p_branch: rels.append(f"{name}귀문")
            
    return {
        'ganzhi': ganzhi,
        'stem_ten_god': s_ten,
        'branch_ten_god': b_ten,
        'twelve_growth': growth,
        'sinsal': ",".join(sinsal_combined),
        'relations': ",".join(list(set(rels))) if rels else "-"
    }

def calculate_daeun(details, gender):
    """대운 산출 (순행/역행 기준 정립)"""
    try:
        pillars = details['pillars']
        year_stem, year_branch = pillars['year']['stem'], pillars['year']['branch']
        month_pillar, day_gan = pillars['month']['pillar'], pillars['day']['stem']
        day_branch = pillars['day']['branch']
        
        # 순역행 판단: 연간의 음양 + 성별
        is_yang = year_stem in ['甲', '丙', '戊', '庚', '壬']
        is_forward = (is_yang and gender == '남') or (not is_yang and gender == '여')
        
        y, m, d = map(int, details['birth_date'].split('-'))
        hh, mm = map(int, details['birth_time'].split(':'))
        daeun_num = calculate_daeun_number(y, m, d, hh, mm, is_forward)
        
        res_list = []
        curr = month_pillar
        for i in range(10):
            curr = get_next_ganzhi(curr) if is_forward else get_prev_ganzhi(curr)
            item = get_ganzhi_details(day_gan, year_branch, curr, pillars=pillars, day_branch=day_branch)
            item['age'] = daeun_num + (i * 10)
            res_list.append(item)
        return {'num': daeun_num, 'list': res_list, 'direction': '순행' if is_forward else '역행'}
    except:
        return {'num': 1, 'list': [], 'direction': '순행'}

def get_seyun_data(day_gan, year_branch, target_year, pillars=None, day_branch=None):
    """세운 산출 (안전 관리 방식)"""
    try:
        from sajupy import get_saju_calculator
        calc = get_saju_calculator()
        res = calc.calculate_saju(int(target_year), 2, 15, 12, 0)
        return get_ganzhi_details(day_gan, year_branch, res.get('year_pillar'), pillars=pillars, day_branch=day_branch)
    except:
        return {}

def get_seyun_list(day_gan, year_branch, start_year, count=10, pillars=None, day_branch=None):
    """지정된 시작 연도부터 N개년 세운 리스트 산출"""
    res = []
    for i in range(count):
        y = start_year + i
        data = get_seyun_data(day_gan, year_branch, y, pillars=pillars, day_branch=day_branch)
        if data:
            data['year'] = y
            res.append(data)
    return res

def get_wolun_data(day_gan, year_branch, year_pillar, target_month, pillars=None, day_branch=None):
    """월운 산출 (명리학 표준: 정월=寅月 기준)"""
    if not year_pillar: return {}
    try:
        y_stem = year_pillar[0]
        # 월두법 (Month Stem Calculation Rule)
        # 甲/己 -> 丙寅(3) 시작, 乙/庚 -> 戊寅(5) 시작, 丙/辛 -> 庚寅(7) 시작, 丁/壬 -> 壬寅(9) 시작, 戊/癸 -> 甲寅(1) 시작
        m_map = {'甲': 2, '己': 2, '乙': 4, '庚': 4, '丙': 6, '辛': 6, '丁': 8, '壬': 8, '戊': 0, '癸': 0}
        
        # 명리학에서 1월은 寅월이므로, target_month가 1일 때 index 2(寅)를 가리켜야 함
        s_idx = (m_map.get(y_stem, 0) + (int(target_month) - 1) * 2) % 10
        b_idx = (EARTHLY_BRANCHES.index('寅') + int(target_month) - 1) % 12
        
        pillar = HEAVENLY_STEMS[s_idx] + EARTHLY_BRANCHES[b_idx]
        res = get_ganzhi_details(day_gan, year_branch, pillar, pillars=pillars, day_branch=day_branch)
        res['month'] = target_month
        return res
    except Exception as e:
        print(f"Error in get_wolun_data: {e}")
        return {}

def get_extended_saju_data(details, gender='여'):
    """전체 데이터 통합 및 확장 (공망 추가)"""
    try:
        pillars = details['pillars']
        day_gan, year_branch = pillars['day']['stem'], pillars['year']['branch']
        day_branch = pillars['day']['branch']
        
        details['ten_gods'] = {p: GAN_TEN_GODS.get(day_gan, {}).get(pillars[p]['stem'], '-') for p in ['year', 'month', 'hour']}
        details['ten_gods']['day'] = '본인'
        details['jiji_ten_gods'] = {p: GAN_TEN_GODS.get(day_gan, {}).get(BRANCH_HIDDEN_GANS.get(pillars[p]['branch']), '-') for p in ['year', 'month', 'day', 'hour']}
        details['twelve_growth'] = {p: TWELVE_GROWTH.get(day_gan, {}).get(pillars[p]['branch'], '-') for p in ['year', 'month', 'day', 'hour']}
        
        details['five_elements'] = {'목':0,'화':0,'토':0,'금':0,'수':0}
        for p in ['year','month','day','hour']:
            for k in [pillars[p]['stem'], pillars[p]['branch']]:
                e = ELEMENTS_MAP.get(k)
                if e: details['five_elements'][e] += 1
                
        # 다중 신살 및 공망
        details['sinsal_details'] = {p: get_ganzhi_details(day_gan, year_branch, pillars[p]['pillar'], day_branch=day_branch) for p in ['year', 'month', 'day', 'hour']}
        details['gongmang'] = {
            'year': get_gongmang(pillars['year']['pillar']),
            'day': get_gongmang(pillars['day']['pillar'])
        }
        
        rels = []
        keys = ['year', 'month', 'day', 'hour']
        names = {'year':'년', 'month':'월', 'day':'일', 'hour':'시'}
        for i in range(4):
            for j in range(i+1, 4):
                s1, s2 = pillars[keys[i]].get('stem'), pillars[keys[j]].get('stem')
                if STEM_RELATIONS['충'].get(s1) == s2: rels.append(f"{names[keys[i]]}-{names[keys[j]]} 충")
                if STEM_RELATIONS['합'].get(s1) == s2: rels.append(f"{names[keys[i]]}-{names[keys[j]]} 합")
                b1, b2 = pillars[keys[i]].get('branch'), pillars[keys[j]].get('branch')
                if BRANCH_RELATIONS['충'].get(b1) == b2: rels.append(f"{names[keys[i]]}-{names[keys[j]]} 충")
                if BRANCH_RELATIONS['합'].get(b1) == b2: rels.append(f"{names[keys[i]]}-{names[keys[j]]} 합")
        details['relations'] = rels
        
        # 하위 호환성을 위한 단순 sinsal 키 복구
        details['sinsal'] = {p: details['sinsal_details'][p]['sinsal'] for p in ['year', 'month', 'day', 'hour']}
        
        details['fortune'] = calculate_daeun(details, gender)
        return details
    except Exception as e:
        print(f"Error in get_extended_saju_data: {e}")
        return details
